## The diaspora* social network on Fedora CoreOS

This project provides a terraform module to provision a [diaspora*](https://diasporafoundation.org/) pod on
[Fedora CoreOS](https://getfedora.org/de/coreos?stream=stable).

## Description

A pod installation on CoreOS is special in two ways:

* All services are running as containers
* The machine is (usually a vm and) provisioned at first startup with an [ignition file](https://coreos.github.io/ignition/).
  Usually this includes service container installation with respective config files etc.
  
There are several ways to produce an ignition and one of them is [terraform](https://www.terraform.io/) with the
[poseidon/ct](https://registry.terraform.io/providers/poseidon/ct/latest) provider. This project makes use of this
provider to generate an ignition suitable for provisioning and installation of a complete Fedora CoreOS machine with
a diaspora* pod. It does also make use of the [fcos-ignition-snippets](https://github.com/ecky-l/fcos-ignition-snippets)
module to produce common ignition fragments, including special partition setup. The resulting machine has a small root
partition, which is large enough to hold two ostree deployments and the container metadata plus some configuration, and
a presumably large data partition for the diaspora data, that can survive a reprovisioning (as long as the partition
sizes are not changed). That means that the root partition can be recreated at any time without loosing the data - 
nevertheless it makes sense to pull backups of the data.

There are several ways to attach an ignition file to a new VM/image to boot and configure the image. One of them is PXE
boot boot. Besides retrieving the rendered ignition file, this is currently the only implemented method in this project
It requires a machine running a matchbox service and a PXE boot environment. The project
[fcos-pxe-bootstrapper](https://github.com/ecky-l/fcos-pxe-bootstrapper) could help to provision such a service and
environment. For general information, see [the matchbox docs](https://matchbox.psdn.io/network-booting/). For PXE boot
you need a private network and the target machines must have at least 3GB RAM. The private network is usually provided
by your cloud/hosting provider, eventually for additional charges. For a playground lab to get started, you can use
VirtualBox. There are examples in this module and the fcos-pxe-bootstrapper module which utilize VirtualBox VMs (the 
"private network" is the internal network in VirtualBox).

## Usage

There are two modules here:

* *fcos-diaspora-ignition* generates and outputs the raw ignition file for CoreOS configuration. You can use this if you
  want to produce the ignition only, e.g. to attach it to a qemu VM as described in the
  [docs](https://docs.fedoraproject.org/en-US/fedora-coreos/provisioning-qemu/).  

* *fcos-diaspora-matchbox* takes as input an ignition (generated by fcos-diaspora-ignition) and generates a matchbox
  profile on the given endpoint for the given MAC address. You can use that to bootstrap a Host over PXE as described
  above.
  
The virtualbox example shows a terraform module which uses both modules for PXE bootstrap. To use it, you must have a VM
in your VirtualBox environment already running with a matchbox service and PXE environment, e.g. from the
[fcos-pxe-bootstrapper](https://github.com/ecky-l/fcos-pxe-bootstrapper) module mentioned above. You must edit the
values as needed (especially the url, the matchbox url, the matchbox cert paths and the MAC address). Then run
`terraform init`, `terraform plan` and `terraform apply` in the examples/virtualbox directory. It will upload a matchbox
profile to the matchbox service on your VirtualBox environment, which is later delivered when the host with the
specified mac address is turned on. The mac address is the one of an attached internal network NIC that can connect to
the PXE bootstrapper machine.

A real world deployment works the same but with different parameters. You must have a matchbox/PXE environment running
in your public hosting platform. Then you write a module that source's this project's module, i.e.

```
module "my_diaspora_pod" {
  source = "git::https://github.com/ecky-l/fcos-diaspora.git//modules/fcos-diaspora-matchbox"
  ...
}
```

Like in the example but with real parameters. The ignition snippets are also necessary, at least for the core user
authorized keys. The terraform matchbox provider configuration (see examples/virtualbox/providers.tf) points to your
matchbox service. Then, a `terraform apply` will generate the profile in your real matchbox environment and the machine
can be started and will be ready within a few minutes.

Alternately you can just use the *fcos-diaspora-ignition* module to generate an ignition, which you later attach to a VM
of your choice. The raw ignition can also be used for provisioning VMs on various cloud providers like AWS, GCP etc.

## Data migration / restoration steps

This assumes that the diaspora pod is already running. It is not necessary to stop it, unless there is no data coming in.

* create a backup from old diaspora database on the old host
```
pg_dump diaspora_production -Ft -f diaspora_production.dump
```

* create a backup of uploads directory content on the old host
```
tar -C <path/to/diaspora/public/uploads> --preserve-permissions --same-owner -czf /tmp/diaspora_uploads.tar.gz images tmp users
```

* download both files and place them on the new host to
  * `/mnt/data/postgresql/backups/diaspora_production.dump`
  * `/mnt/data/diaspora/backups/diaspora_uploads.tar.gz`

* execute the database restore
```
sudo podman exec -it postgresql \
    pg_restore \
        -U diaspora \
        -h localhost \
        -d diaspora_production \
        -O -x -c --if-exists -Ft \
        /var/local/postgresql-backups/diaspora_production.dump 
```

* execute the uploads restore
```
tar -C /mnt/data/diaspora/public/uploads xvz -f /mnt/data/diaspora/backups/diaspora_uploads.tar.gz
```

* restart the diaspora-ct container to trigger database migration
```
sudo podman restart diaspora-ct
```